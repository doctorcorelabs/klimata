name: Deploy Chatbot Worker

# Disabled automatic runs on push to avoid accidental publishes from this repo.
# This workflow now runs manually via the Actions UI (workflow_dispatch).
on:
  workflow_dispatch: {}

jobs:
  deploy:
    name: Publish Worker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Set OpenRouter API key as a Cloudflare Worker secret (non-interactive)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          # Write secret value to Cloudflare using wrangler non-interactively.
          # This pipes the secret into `wrangler secret put` so it doesn't require a TTY.
          printf '%s' "$OPENROUTER_API_KEY" | wrangler secret put OPENROUTER_API_KEY
        # Note: The API token must have permissions to edit Worker scripts/secrets.

      - name: Publish
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd cloudflare-worker
          wrangler publish
